<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; font-style:italic; text-decoration: underline;">Язык C: malloc/free</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Статья про отказ от освобождения памяти при malloc и free. <br />https://habrahabr.ru/post/158347/<br />Жаль, что причины такого поведения скрываются за &quot;такая уж работа malloc&quot; без особой аргументации.<br />В добавок к комментариям реализацию mmap можно посмотреть тут: https://elixir.free-electrons.com/linux/latest/source/mm/mmap.c<br /><br />В кратце: При размере равном:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">520168 байт и выше — освобождение проходит нормально</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">520167 байт и ниже — имеем описанную проблему</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /><span style=" font-weight:600; font-style:italic; text-decoration: underline;">Язык C++: new/delete</span><br /><br /><span style=" font-family:'sans-serif'; font-size:14px; color:#000000;">Переменная объектного типа в динамической памяти создаётся в два этапа:</span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'sans-serif'; font-size:14px; color:#000000;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14px;">Выделяется память с помощью </span><span style=" font-size:14px; text-decoration: underline;">оператора</span><span style=" font-size:14px;"> new.</span></li>
<li style=" font-family:'sans-serif'; font-size:14px; color:#000000;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14px;">Вызывается конструктор класса.</span></li></ol>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:14px; color:#000000;">Удаляется такая переменная тоже в два этапа:</span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'sans-serif'; font-size:14px; color:#000000;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14px;">Вызывается деструктор класса.</span></li>
<li style=" font-family:'sans-serif'; font-size:14px; color:#000000;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14px;">Освобождается память с помощью </span><span style=" font-size:14px; text-decoration: underline;">оператора</span><span style=" font-size:14px;"> delete.</span></li></ol>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The new-expression attempts to create an object of the type-id or new-type-id to which it is applied. /*дальше нам не интересно*/<br /><br />void* operator new(std::size_t size) throw(std::bad_alloc);<br />Effects: The allocation function called by a new-expression (5.3.4) to allocate size bytes of storage suitably aligned to represent any object of that size.<br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#4078f2;">#include </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#50a14f;">&lt;iostream&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#a626a4;">class</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;"> Test {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#a626a4;">public</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">    Test() {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">        </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#c18401;">std</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">::</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#c18401;">cout</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;"> &lt;&lt; </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#50a14f;">&quot;Test::Test()&quot;</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;"> &lt;&lt; </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#c18401;">std</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">::</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#c18401;">endl</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">    </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#a626a4;">void</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42;">* </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#a626a4;">operator</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#4078f2;">new</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42;"> (</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#c18401;">std</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42;">::size_t size) </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#4078f2;">throw</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42;"> (</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#c18401;">std</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42;">::bad_alloc) </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">        </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#c18401;">std</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">::</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#c18401;">cout</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;"> &lt;&lt; </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#50a14f;">&quot;Test::operator new(&quot;</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;"> &lt;&lt; size &lt;&lt; </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#50a14f;">&quot;)&quot;</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;"> &lt;&lt; </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#c18401;">std</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">::</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#c18401;">endl</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">        </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#a626a4;">return</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;"> ::</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#a626a4;">operator</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#4078f2;">new</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42;">(size)</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#a626a4;">int</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#4078f2;">main</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42;">() </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">    Test *t = </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#a626a4;">new</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;"> Test();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">    </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#a626a4;">void</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;"> *p = Test::</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#a626a4;">operator</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#4078f2;">new</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42;">(</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#986801;">100</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42;">)</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">; </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; font-style:italic; color:#a0a1a7;">// 100 для различия в выводе</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">}</span><br /><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#222222; background-color:#ffffff;">Этот код выведет следующее </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">Test::operator new(1)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">Test::Test()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#383a42; background-color:#fbfdff;">Test::operator new(100)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Код взят с https://habrahabr.ru/post/185662/<br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; font-style:italic; text-decoration: underline;">Язык C++: new[]/delete[]</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:14px; color:#000000;">Массив объектов создаётся в два этапа:</span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'sans-serif'; font-size:14px; color:#000000;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14px;">Выделяется память, необходимая для размещения массива объектов.</span></li>
<li style=" font-family:'sans-serif'; font-size:14px; color:#000000;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14px;">Для каждого из элементов массива вызывается конструктор по умолчанию.</span></li></ol>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'sans-serif'; font-size:14px; color:#000000;">Удаляется массив объектов тоже в два этапа:</span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'sans-serif'; font-size:14px; color:#000000;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14px;">Для всех элементов массива вызываются деструкторы.</span></li>
<li style=" font-family:'sans-serif'; font-size:14px; color:#000000;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:14px;">С помощью оператора delete освобождается память, занимаемая массивом.</span></li></ol>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">На этапе компиляции неизвестно, на сколько элементов выделяется массив, а значит без использования дополнительной информации невозможно вызвать деструкторы всех элементов массива.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">К примеру, механизм создания и удаления массивов объектов может быть реализован следующим образом (рисунок ниже). С помощью функции operator new выделяется размер памяти, равный суммарному размеру всех элементов массива и размеру служебной информации. Оператор new выделяет память и возвращает, допустим, указатель p. По этому указателю записывается служебная информация, а в программу возвращается указатель на первый элемент массива. Аналогично, при вызове delete, в функцию operator delete передаётся не указатель на первый элемент массива, а указатель, на начало блока, выделенного оператором new.<br /><img src="image6281.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; font-style:italic; text-decoration: underline;">C++ без new и delete</span><span style=" font-weight:600; text-decoration: underline;"><br /></span>https://habrahabr.ru/company/aligntechnology/blog/283352/</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; font-style:italic; text-decoration: underline;">Прекрасное руководство по написанию собственного аллокатора памяти</span><br />https://habrahabr.ru/post/148657/</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; font-style:italic; text-decoration: underline;">Memory management в ядре Linux. Семинар в Яндексе</span><br />https://habrahabr.ru/company/yandex/blog/231957/</p></body></html>