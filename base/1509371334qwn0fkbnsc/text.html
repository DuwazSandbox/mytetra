<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Важной частью компилятора является аллокатор регистров. Он выполняется после планировщика (scheduler), который генерирует уже практически финальный код в машинных инструкциях, но вместо физических регистров используются виртуальные регистры.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Работа аллокатора регистров заключается в том, чтобы назначить физические регистры вместо виртуальных. Количество физических регистров ограничено, виртуальных регистров потенциально неограниченное число, поэтому физических регистов может не хватить, тогда аллокатор должен сделать спиллинг (spill) виртуального регистра, то есть вставить команду, сохраняющую значение регистра в стеке, а перед использованием этого регистра извлечь значение из стека.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Также аллокатор регистров применяет множество техник оптимизации, таких, как рематериализация констант, изменение порядка выполнения инструкций, разделение виртуального регистра на несколько и т.п. </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Хорошая новость состоит в том, что в LLVM есть готовый аллокатор (и не один), не требующий доработок со стороны разработчика бэкенда, то есть он работает просто на основании описания набора регистров.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Плохая новость состоит в том, что в ряде случаев, если у вас необычная архитектура, вообще нет регистров (2-х или 3-х адресная архитектура), стековая машина или что-то такое, он работать не будет.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вторая хорошая новость состоит в том, что даже в таких тяжёлых случаях вы можете написать свой аллокатор, причём он будет даже проще стандартного. Намного проще, ведь не нужны будут сложные алгоритмы раскраски графа, реордеринга, сплиттинга и прочего. Можно просто назначать виртуальным регистрам смещения в стеке, например.</p></body></html>